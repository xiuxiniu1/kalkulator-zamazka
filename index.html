<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä –∑–∞ –∑–∞–º–∞–∑–∫–∞</title>
  <link rel="manifest" href="manifest.json">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#ffffff"/>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="–ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä –∑–∞ –∑–∞–º–∞–∑–∫–∞" />
  <link rel="apple-touch-icon" href="icon.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }
    input, button {
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
    }
    .room {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
    }
    #summary {
      font-weight: bold;
      margin-top: 20px;
      background-color: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      white-space: pre-wrap;
    }
    #controls button {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>–ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä –∑–∞ –∑–∞–º–∞–∑–∫–∞</h2>

  <label><strong>–ò–º–µ –Ω–∞ –æ–±–µ–∫—Ç:</strong></label>
  <input type="text" id="projectName" placeholder="–Ω–∞–ø—Ä. –ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –í–∏—Ç–æ—à–∞ 3, –µ—Ç–∞–∂ 2" />

  <div id="rooms"></div>

  <div id="controls">
    <button onclick="addRoom()">+ –î–æ–±–∞–≤–∏ —Å—Ç–∞—è</button>
    <button onclick="calculateAll()">–ò–∑—á–∏—Å–ª–∏ –≤—Å–∏—á–∫–∏</button>
    <button onclick="exportPDF()">üìÑ –ï–∫—Å–ø–æ—Ä—Ç –≤ PDF</button>
  </div>

  <div id="summary"></div>

  <script>
    let roomCount = 0;

    function round2(x) {
      return Math.round(x * 100) / 100;
    }

    function addRoom() {
      const roomsDiv = document.getElementById('rooms');
      roomCount++;

      const roomDiv = document.createElement('div');
      roomDiv.className = 'room';
      roomDiv.id = `room-${roomCount}`;
      roomDiv.innerHTML = `
        <h3>–°—Ç–∞—è ${roomCount}</h3>
        <label>–ò–º–µ –Ω–∞ —Å—Ç–∞—è:</label>
        <input type="text" class="room-name" placeholder="–Ω–∞–ø—Ä. –°–ø–∞–ª–Ω—è, –•–æ–ª" />
        <label>–î–µ–±–µ–ª–∏–Ω–∏ (–≤ —Å–º, –æ—Ç 1 –¥–æ 20, —Ä–∞–∑–¥–µ–ª–µ–Ω–∏ —Å—ä—Å –∑–∞–ø–µ—Ç–∞—è):</label>
        <input type="text" class="thicknesses" placeholder="–Ω–∞–ø—Ä. 5.2, 5.55, 6.1" />
        <label>–ö–≤–∞–¥—Ä–∞—Ç—É—Ä–∞ (–≤ m¬≤):</label>
        <input type="number" class="area" placeholder="–Ω–∞–ø—Ä. 30.75" step="0.01" />
        <div class="result"></div>
      `;

      roomsDiv.appendChild(roomDiv);
    }

    function calculateAll() {
      const roomDivs = document.querySelectorAll('.room');
      let totalVolume = 0;
      let totalArea = 0;
      let roomCounter = 0;
      let summaryHTML = '';
      let exportLines = [];

      roomDivs.forEach((roomDiv, index) => {
        const nameInput = roomDiv.querySelector('.room-name').value || `–°—Ç–∞—è ${index + 1}`;
        const thicknessInput = roomDiv.querySelector('.thicknesses').value;
        const areaRaw = parseFloat(roomDiv.querySelector('.area').value);
        const resultDiv = roomDiv.querySelector('.result');

        const thicknesses = thicknessInput
          .split(',')
          .map(t => parseFloat(t.trim()))
          .filter(t => !isNaN(t));

        const validThicknesses = thicknesses.filter(t => t >= 1 && t <= 20);

        if (thicknesses.length === 0 || isNaN(areaRaw) || validThicknesses.length !== thicknesses.length) {
          resultDiv.innerHTML = `<span style="color:red">–ú–æ–ª—è, –≤—ä–≤–µ–¥–∏ –¥–µ–±–µ–ª–∏–Ω–∏ –º–µ–∂–¥—É 1 –∏ 20 —Å–º –∏ –∫–≤–∞–¥—Ä–∞—Ç—É—Ä–∞.</span>`;
          return;
        }

        const avgThickness = thicknesses.reduce((a, b) => a + b, 0) / thicknesses.length;
        const avgRounded = round2(avgThickness);
        const area = round2(areaRaw);
        const volume = round2((avgRounded / 100) * area);

        totalVolume += volume;
        totalArea += area;
        roomCounter++;

        resultDiv.innerHTML = `
          <strong>${nameInput}</strong><br>
          –°—Ä–µ–¥–Ω–∞ –¥–µ–±–µ–ª–∏–Ω–∞: ${avgRounded} —Å–º<br>
          –û–±–µ–º: ${volume} m¬≥
        `;

        summaryHTML += `${nameInput}: ${volume} m¬≥ / ${area} m¬≤
`;

        exportLines.push(
          `${nameInput}`,
          `  –î–µ–±–µ–ª–∏–Ω–∏: ${thicknessInput}`,
          `  –ü–ª–æ—â: ${area} m¬≤`,
          `  –°—Ä–µ–¥–Ω–∞ –¥–µ–±–µ–ª–∏–Ω–∞: ${avgRounded} —Å–º`,
          `  –û–±–µ–º: ${volume} m¬≥`,
          ``
        );
      });

      const totalAreaRounded = round2(totalArea);
      const totalVolumeRounded = round2(totalVolume);
      const avgThicknessTotal = totalAreaRounded > 0 ? round2((totalVolumeRounded / totalAreaRounded) * 100) : 0;

      summaryHTML += `
–ë—Ä–æ–π —Å—Ç–∞–∏: ${roomCounter}
–û–±—â–∞ –∫–≤–∞–¥—Ä–∞—Ç—É—Ä–∞: ${totalAreaRounded} m¬≤
–û–±—â–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Ç–µ—Ä–∏–∞–ª: ${totalVolumeRounded} m¬≥
–°—Ä–µ–¥–Ω–∞ –¥–µ–±–µ–ª–∏–Ω–∞ –Ω–∞ —Ü–µ–ª–∏—è –æ–±–µ–∫—Ç: ${avgThicknessTotal} —Å–º
`;

      exportLines.push(`---`);
      exportLines.push(`–ë—Ä–æ–π —Å—Ç–∞–∏: ${roomCounter}`);
      exportLines.push(`–û–±—â–∞ –∫–≤–∞–¥—Ä–∞—Ç—É—Ä–∞: ${totalAreaRounded} m¬≤`);
      exportLines.push(`–û–±—â–æ –º–∞—Ç–µ—Ä–∏–∞–ª: ${totalVolumeRounded} m¬≥`);
      exportLines.push(`–°—Ä–µ–¥–Ω–∞ –¥–µ–±–µ–ª–∏–Ω–∞ –Ω–∞ —Ü–µ–ª–∏—è –æ–±–µ–∫—Ç: ${avgThicknessTotal} —Å–º`);

      document.getElementById('summary').textContent = summaryHTML;

      const project = document.getElementById("projectName").value || "–ë–µ–∑ –∏–º–µ";
      window.latestExportData = {
        name: project,
        lines: exportLines
      };
    }

    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const data = window.latestExportData;

      if (!data || !data.lines.length) {
        alert("–ú–æ–ª—è –ø—ä—Ä–≤–æ –Ω–∞—Ç–∏—Å–Ω–∏ '–ò–∑—á–∏—Å–ª–∏ –≤—Å–∏—á–∫–∏'");
        return;
      }

      doc.setFont("helvetica");
      doc.setFontSize(14);
      doc.text(`–ö–∞–ª–∫—É–ª–∞—Ü–∏—è –∑–∞ –∑–∞–º–∞–∑–∫–∞`, 15, 20);
      doc.setFontSize(11);
      doc.text(`–û–±–µ–∫—Ç: ${data.name}`, 15, 30);

      doc.setFontSize(10);
      const content = doc.splitTextToSize(data.lines.join("
"), 180);
      doc.text(content, 15, 40);

      doc.save(`zamazka-${data.name.replace(/\s+/g, "_")}.pdf`);
    }

    addRoom();
  </script>
</body>
</html>
